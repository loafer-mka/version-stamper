# +--------------------------------------------------------------------+
# | This Source Code Form is subject to the terms of the Mozilla       |
# | Public License, v. 2.0. If a copy of the MPL was not distributed   |
# | with this file, You can obtain one at http://mozilla.org/MPL/2.0/. |
# +--------------------------------------------------------------------+

function __PLUGIN_C_NOTICE__
{
	echo "   plugin-C          C-style defines, normally version file is .h; eol=native"
}

function __PLUGIN_C_SAMPLE__
{
	echo "#plugin-C:        --gitignore  version.h"
}

function __PLUGIN_C_GETVER__
{
	sed --binary --regexp-extended --silent \
		-e "s/^(\s*#\s*define\s+${VERSION_LEADER}VERSION_TEXT${VERSION_TRAILER}\s+\")(.*)(\".*)$/\\2/p"
}

function __PLUGIN_C_CREATE__
{
	__STORE_NATIVE_EOL__ "$1" <<-END_OF_TEXT
		#ifndef	__${VERSION_LEADER}VERSION${VERSION_TRAILER}_H__
		#	define	__${VERSION_LEADER}VERSION${VERSION_TRAILER}_H__
		#	define	${VERSION_LEADER}VERSION${VERSION_TRAILER}             0x${VERSION_HEX}L
		#	define	${VERSION_LEADER}VERSION_TEXT${VERSION_TRAILER}        "${VERSION_TEXT}"
		#	define	${VERSION_LEADER}VERSION_DATE${VERSION_TRAILER}        "${VERSION_DATE}"
		#	define	${VERSION_LEADER}VERSION_SHORTDATE${VERSION_TRAILER}   "${VERSION_SHORTDATE}"
		#	define	${VERSION_LEADER}VERSION_UNIXTIME${VERSION_TRAILER}    ${VERSION_UNIXTIME}LL
		#	define	${VERSION_LEADER}VERSION_BRANCH${VERSION_TRAILER}      "${VERSION_BRANCH}${VERSION_DIRTY}"
		#	define	${VERSION_LEADER}VERSION_HOSTINFO${VERSION_TRAILER}    "${VERSION_HOSTINFO//\"/\\\"}"
		#	define	${VERSION_LEADER}VERSION_AUTHORSHIP${VERSION_TRAILER}  "${VERSION_AUTHORSHIP//\"/\\\"}"
		#	define	${VERSION_LEADER}VERSION_DECLARATION${VERSION_TRAILER} "${VERSION_DECLARATION//\"/\\\"}"
		// information below may be based on parent commit's hash
		#	define	${VERSION_LEADER}VERSION_SHA_ABBREV${VERSION_TRAILER}  "${VERSION_SHA_ABBREV}"
		#	define	${VERSION_LEADER}VERSION_SHA${VERSION_TRAILER}         "${VERSION_SHA}"
		#endif
END_OF_TEXT
}

function __PLUGIN_C_MODIFY__
{
	sed --binary --regexp-extended \
		-e "s/^(\s*#\s*define\s+${VERSION_LEADER}VERSION${VERSION_TRAILER}\s+)(0x[0-9A-Fa-f]+L?|[0-9]*L?)(.*)$/\\10x${VERSION_HEX}L\\3/" \
		-e "s/^(\s*#\s*define\s+${VERSION_LEADER}VERSION_TEXT${VERSION_TRAILER}\s+)(\".*\")(.*)$/\\1\"${VERSION_TEXT}\"\\3/" \
		-e "s/^(\s*#\s*define\s+${VERSION_LEADER}VERSION_BRANCH${VERSION_TRAILER}\s+)(\".*\")(.*)$/\\1\"${VERSION_BRANCH}${VERSION_DIRTY}\"\\3/" \
		-e "s/^(\s*#\s*define\s+${VERSION_LEADER}VERSION_DATE${VERSION_TRAILER}\s+)(\".*\")(.*)$/\\1\"${VERSION_DATE}\"\\3/" \
		-e "s/^(\s*#\s*define\s+${VERSION_LEADER}VERSION_SHORTDATE${VERSION_TRAILER}\s+)(\".*\")(.*)$/\\1\"${VERSION_SHORTDATE}\"\\3/" \
		-e "s/^(\s*#\s*define\s+${VERSION_LEADER}VERSION_UNIXTIME${VERSION_TRAILER}\s+)([0-9]+L?L?)(.*)$/\\1${VERSION_UNIXTIME}LL\\3/" \
		-e "s/^(\s*#\s*define\s+${VERSION_LEADER}VERSION_HOSTINFO${VERSION_TRAILER}\s+)(\".*\")(.*)$/\\1\"${VERSION_HOSTINFO//\"/\\\\\"}\"\\3/" \
		-e "s/^(\s*#\s*define\s+${VERSION_LEADER}VERSION_AUTHORSHIP${VERSION_TRAILER}\s+)(\".*\")(.*)$/\\1\"${VERSION_AUTHORSHIP//\"/\\\\\"}\"\\3/" \
		-e "s/^(\s*#\s*define\s+${VERSION_LEADER}VERSION_DECLARATION${VERSION_TRAILER}\s+)(\".*\")(.*)$/\\1\"${VERSION_DECLARATION//\"/\\\\\"}\"\\3/" \
		-e "s/^(\s*#\s*define\s+${VERSION_LEADER}VERSION_SHA_ABBREV${VERSION_TRAILER}\s+)(\".*\")(.*)$/\\1\"${VERSION_SHA_ABBREV}\"\\3/" \
		-e "s/^(\s*#\s*define\s+${VERSION_LEADER}VERSION_SHA${VERSION_TRAILER}\s+)(\".*\")(.*)$/\\1\"${VERSION_SHA}\"\\3/" | __STORE_NATIVE_EOL__ "$1"
}

function __PLUGIN_C_ATTRIB__
{
	echo "text"
}
